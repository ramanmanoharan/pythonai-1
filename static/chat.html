<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VELLORE AI - Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; overflow-x: hidden; }
        
        .bg-animation { position: fixed; width: 100%; height: 100%; z-index: 0; }
        .floating-shape { position: absolute; border-radius: 50%; opacity: 0.1; animation: float 20s infinite; }
        .shape1 { width: 300px; height: 300px; background: linear-gradient(135deg, #ffd700, #ff6b6b); top: 10%; left: 10%; }
        .shape2 { width: 200px; height: 200px; background: linear-gradient(135deg, #667eea, #764ba2); top: 60%; right: 10%; animation-delay: 5s; }
        @keyframes float { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-50px) rotate(180deg); } }
        
        .sidebar { position: fixed; left: 0; top: 0; width: 280px; height: 100vh; background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(10px); padding: 20px; z-index: 100; transition: transform 0.3s; }
        .logo-box { display: flex; align-items: center; gap: 15px; margin-bottom: 40px; padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 15px; }
        .logo-icon { width: 60px; height: 60px; background: linear-gradient(135deg, #ffd700, #ff6b6b); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 32px; animation: rotate3d 4s infinite; }
        @keyframes rotate3d { 0%, 100% { transform: rotateY(0deg); } 50% { transform: rotateY(180deg); } }
        .logo-text { font-size: 20px; font-weight: bold; background: linear-gradient(to right, #ffd700, #ff6b6b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .nav-item { padding: 15px 20px; margin: 10px 0; border-radius: 12px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 12px; }
        .nav-item:hover { background: rgba(255, 255, 255, 0.1); transform: translateX(5px); }
        
        .main-content { margin-left: 280px; height: 100vh; display: flex; flex-direction: column; }
        .header { background: rgba(0, 0, 0, 0.2); backdrop-filter: blur(10px); padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; }
        .user-info { display: flex; gap: 15px; align-items: center; }
        .login-btn { background: linear-gradient(135deg, #ffd700, #ff6b6b); padding: 10px 25px; border-radius: 25px; border: none; color: white; font-weight: bold; cursor: pointer; }
        
        .chat-section { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow: hidden; }
        .chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .message { display: flex; gap: 15px; animation: slideIn 0.3s; }
        .message.user { flex-direction: row-reverse; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
        .user-avatar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .bot-avatar { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .message-bubble { max-width: 70%; padding: 15px 20px; border-radius: 20px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); }
        .message.user .message-bubble { background: rgba(255, 255, 255, 0.2); }
        
        .input-area { background: rgba(0, 0, 0, 0.2); backdrop-filter: blur(10px); padding: 20px; border-radius: 25px; margin: 0 20px 20px; }
        .input-wrapper { display: flex; gap: 10px; align-items: center; }
        .input-box { flex: 1; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 25px; padding: 15px 20px; color: white; font-size: 16px; outline: none; }
        .input-box::placeholder { color: rgba(255, 255, 255, 0.6); }
        .send-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        
        .typing-indicator { display: none; }
        .typing-indicator.active { display: flex; gap: 5px; padding: 15px; }
        .dot { width: 10px; height: 10px; background: white; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out; }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        .map-container { width: 100%; height: 300px; border-radius: 15px; overflow: hidden; margin-top: 10px; }
        .code-block { background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 10px; margin: 10px 0; overflow-x: auto; font-family: 'Courier New', monospace; }
    </style>
</head>
<body>
    <div class="bg-animation">
        <div class="floating-shape shape1"></div>
        <div class="floating-shape shape2"></div>
    </div>
    
    <div class="sidebar">
        <div class="logo-box">
            <div class="logo-icon">ðŸ§ </div>
            <div class="logo-text">VELLORE AI</div>
        </div>
        <div class="nav-item" onclick="window.location.href='/'">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </div>
        <div class="nav-item" onclick="resetChat()">
            <i class="fas fa-redo"></i>
            <span>New Chat</span>
        </div>
        <div class="nav-item" id="logoutBtn" style="display: none;" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <h2>VELLORE AI Assistant</h2>
            <div class="user-info">
                <span id="username"></span>
                <button class="login-btn" id="loginBtn" onclick="window.location.href='/login.html'">Login / Signup</button>
            </div>
        </div>

        <div class="chat-section">
            <div class="chat-container" id="chatContainer">
                <div class="message">
                    <div class="avatar bot-avatar"><i class="fas fa-robot"></i></div>
                    <div class="message-bubble">
                        <strong>Welcome to VELLORE AI! ðŸš€</strong><br><br>
                        I can help you with:<br>
                        â€¢ Coding & Programming<br>
                        â€¢ Location & Map Search<br>
                        â€¢ General Knowledge<br><br>
                        <em>Login to save your chat history!</em>
                    </div>
                </div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                <div class="avatar bot-avatar"><i class="fas fa-robot"></i></div>
                <div class="message-bubble">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            </div>

            <div class="input-area">
                <div class="input-wrapper">
                    <input type="text" class="input-box" id="messageInput" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
                    <button class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const sessionId = 'user_' + Math.random().toString(36).substr(2, 9);
        const token = localStorage.getItem('token');
        const username = localStorage.getItem('username');
        
        if (token && username) {
            document.getElementById('username').textContent = 'Hi, ' + username;
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'flex';
            loadChatHistory();
        }
        
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            location.reload();
        }
        
        async function loadChatHistory() {
            try {
                const response = await fetch('/history', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await response.json();
                if (data.messages) {
                    data.messages.forEach(msg => {
                        addMessage(msg.message, msg.is_user);
                    });
                }
            } catch (error) {
                console.log('No history available');
            }
        }
        
        function addMessage(content, isUser, type = 'text') {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : ''}`;
            
            let contentHtml = content;
            if (type === 'map' && content.mapUrl) {
                contentHtml = content.response + '<div class="map-container"><iframe width="100%" height="100%" frameborder="0" src="' + content.mapUrl + '"></iframe></div>';
            }
            
            messageDiv.innerHTML = `
                <div class="avatar ${isUser ? 'user-avatar' : 'bot-avatar'}">
                    <i class="fas fa-${isUser ? 'user' : 'robot'}"></i>
                </div>
                <div class="message-bubble">${contentHtml}</div>
            `;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;
            
            addMessage(message, true);
            input.value = '';
            
            document.getElementById('typingIndicator').classList.add('active');
            
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (token) headers['Authorization'] = 'Bearer ' + token;
                
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ message, session_id: sessionId })
                });
                
                const data = await response.json();
                document.getElementById('typingIndicator').classList.remove('active');
                
                if (data.type === 'map') {
                    addMessage(data, false, 'map');
                } else {
                    addMessage(data.response, false);
                }
            } catch (error) {
                document.getElementById('typingIndicator').classList.remove('active');
                addMessage('Sorry, something went wrong. Please try again.', false);
            }
        }
        
        async function resetChat() {
            const headers = {};
            if (token) headers['Authorization'] = 'Bearer ' + token;
            
            await fetch(`/reset/${sessionId}`, { method: 'POST', headers });
            document.getElementById('chatContainer').innerHTML = `
                <div class="message">
                    <div class="avatar bot-avatar"><i class="fas fa-robot"></i></div>
                    <div class="message-bubble">
                        <strong>Chat reset! ðŸ”„</strong><br><br>
                        How can I help you today?
                    </div>
                </div>
            `;
        }
        
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
    </script>
</body>
</html>
